+++
title = "GuixでRustのパッケージを作成する (2025年版)"
author = ["ROCKTAKEY"]
lastmod = 2025-10-14T00:49:04+09:00
tags = ["GNU-Guix", "Scheme"]
draft = true
+++

いままでRustのパッケージはすべてGuixのパッケージと一対一対応していた。そのため、あるRustパッケージをビルドするためには、 `#:cargo-inputs` として引数に渡されている依存パッケージを全てビルドする必要があった(たしかビルドしないというオプションはあったはずだが)。一方Rustのビルドプロセス上、全ての依存はソースコードを利用してコンパイルされるため、依存パッケージがバイナリへビルドされている必要は全くなかった。また、Rustパッケージに対応するGuixパッケージの数も依存の数に応じてどんどん増えていってしまうなど、管理上の問題も多数あった。

しかし[2025年にその方針が改められ、バイナリが真に必要なRustパッケージ以外は全てソースコードのみの依存とすることとなった](https://guix.gnu.org/blog/2025/a-new-rust-packaging-model/)。これは革命的で、これによってRustのパッケージに対応するGuixパッケージは「ユーザにアプリケーションとして利用されるもの」「Rustパッケージ以外にライブラリとして利用されるもの」くらいになる。これに伴ってRustパッケージの作成もかなり簡単になったので、その方法をここで説明する。


## 前提条件 {#前提条件}

チャンネルは既に保持しているものとする。もし持っていない場合は、[Guixのパッケージをつくってみよう-その1: 簡単なフォントのパッケージを作る](https://blog.rocktakey.com/information-science/2022-770eb4b6-5c63-62d4-bbcb-475d92404603/)などを参考に作成して欲しい。


## 要約 {#要約}

-   Rustのパッケージの依存先のみを管理するファイルである `mychannel/packages/rust-crates.scm` を用意する (初回のみ。通常は全パッケージ共通)。
-   対象となるパッケージの `Cargo.lock` (`/path/to/Cargo.lock`) を入手する (バージョンに注意。gitレポジトリならきちんとタグをチェックアウトすること)。
-   `guix import --insert=/path/to/mychannel/packages/rust-crates.scm crates -f /path/to/Cargo.lock <PACKAGE名>` を実行する。
-   `guix import --insert=/path/to/mychannel/packages/rust-apps.scm crates <PACKAGE名>` を実行する (このファイルはパッケージ毎に変えてもよい)。
-   `(cargo-inputs <PACKAGE名>)` を `(cargo-inputs <PACKAGE名> #:module '(mychannel packages rust-crates))` に置き換える (初回に作成したRustパッケージ用モジュール)。
-   取得しきれていないメタデータの補完や、Guix特有の問題に起因するビルドフェーズの修正を行う。


## Rustのパッケージの依存先のみを管理するファイルを用意する {#rustのパッケージの依存先のみを管理するファイルを用意する}


## 依存をソースコードとしてインポートする {#依存をソースコードとしてインポートする}


## 本体をGuixパッケージとしてインポートする {#本体をguixパッケージとしてインポートする}


## できたパッケージを調整する {#できたパッケージを調整する}

大半の場合そのままではビルドできないので、以下によくある対処を記載しておきます。


### ビルドでコンパイルエラーが出る {#ビルドでコンパイルエラーが出る}

Rustのバージョンを変更する(`#:rust` 、rustupも)


### 依存がみつからない {#依存がみつからない}

gitレポジトリへの依存を削除する(`substitute*`)


### インストールで失敗する {#インストールで失敗する}

バイナリやライブラリとしてインストールしたいクレートのディレクトリを指定する(`#:cargo-install-paths`)


### テストが失敗する {#テストが失敗する}

成功しないテストを無効化する(`--skip`)
