+++
title = "GNU Guixに手を入れ、パッチを送って貢献するまで"
author = ["ROCKTAKEY"]
lastmod = 2023-03-28T01:40:53+09:00
tags = ["GNU-Guix", "Scheme"]
draft = true
+++

## 序文 {#序文}

GNU Guixの本体やパッケージは、コミュニティによって維持されています。いくつかパッケージを追加したり、修正したりする機会があったのですが、調べても日本語の情報に乏しく、どのような手順を踏んで行うものなのかに辿り付くのが大変だったので、自分への備忘録も兼ねてここに残しておきます。

なお、パッチの作成にあたっては[Guix-jp](https://guix-jp.gitlab.io/)、特に[Taiju](https://libre.taiju.info/)さんに大変お世話になりました。ここに書いてある内容もそこで教えていただいたことがたくさん含まれています。ここで改めて感謝の意を表します。


## Guixのソースコードを編集する {#guixのソースコードを編集する}

Guixのソースコードは[ここ](https://git.savannah.gnu.org/cgit/guix.git/)にあります。Gitで管理されています。クローンする場合は以下のいずれかのURIを経由してください。

-   git://git.savannah.gnu.org/guix.git
-   <https://git.savannah.gnu.org/git/guix.git>
-   ssh://git.savannah.gnu.org/srv/git/guix.git


### コミットの履歴について {#コミットの履歴について}

コミットメッセージのフォーマットは、Change Logsの形式で書くことが開発中にまで厳密に従う必要はないですが、パッチを生成する前までにはrebaseして、フォーマットに従うようにしてください。詳しくは[GNU Guix公式マニュアル](https://guix.gnu.org/en/manual/devel/en/html_node/Submitting-Patches.html)及び[Change Logs公式マニュアル](https://www.gnu.org/prep/standards/html_node/Change-Logs.html#Change-Logs)を参照してください。また、他の人のパッチやコミットメッセージを眺めてみると、どうすればよいかがわかるかと思います。

今回はバージョン管理システム(ここではGit)のメッセージとしてのChange Logs形式を説明します。先に例を示すと、以下のようになります。以下は、[私が送ったパッチ](https://git.savannah.gnu.org/cgit/guix.git/commit/?h=rust-team&id=c844489350570bae30442b6d264339029bee4f0f)のコミットメッセージです。

```text
gnu: Add skk-jisyo.

* gnu/packages/dictionaries.scm (skk-jisyo): New variable.
```

送ったパッチが新しいパッケージの追加の場合、このように非常に単純なメッセージになります。

行頭がコロン `:` 区切りになっていますが、これについてドキュメントには(私の調べた限りでは)特に記載はなく、慣習的に行われています
(つまりChange Logs形式由来のフォーマットではない)。
`gnu` は、編集したファイルを祖先として含む、プロジェクトのルートディレクトリ直下にあるディレクトリ名です。パッケージはほとんどすべて `gnu/packages/` 以下に定義されていて、私のパッチもここにあるファイルを編集したものなので、
`gnu` としています。別のディレクトリを編集した場合はそのディレクトリ名を書きましょう。コロン以後のメッセージはそのコミットの要約です。場合によっては3行目にあるメッセージと全く同じになっても構いません。

3行目以降は箇条書きで、各項目の先頭にはアスタリスク `*` が利用されます。各項目は `* ファイル名 (変数名): メッセージ` のように、主に3つの成分に分けられます。ファイル名は変更されたファイルのプロジェクトルートからの相対パス、変数名は変更された変数の名前です。複数の変数が変更された場合、カンマ `,` 区切りで繋ぎます(検索できなくなるため、ワイルドカードなどで省略してはいけません)。長くなって改行したい場合は以下([マニュアル](https://www.gnu.org/prep/standards/html_node/Style-of-Change-Logs.html#Style-of-Change-Logs)より引用)のように、行末毎に括弧を閉じて、行頭毎に括弧を開き直してください。
[マニュアル](https://www.gnu.org/prep/standards/html_node/Style-of-Change-Logs.html#Style-of-Change-Logs)によれば、Emacsなどできれいにパースさせるための措置らしいです。

```text
* src/keyboard.c (menu_bar_items, tool_bar_items)
(Fexecute_extended_command): Deal with 'keymap' property.
```

メッセージ部分も改行を含むことが可能です。いずれの場合も、インデントを行う必要はありません。

また、各項目同士の改行の数にも気を付けてください。改行が1つの場合は関連するひとまとまりの変更、改行が2つの場合は関連しない変更として扱われます。ただし、バージョン管理システムのメッセージとしてのChange Logs形式では粒度の関係でそもそも1項目のことが多いです。

既存のパッケージの変更を行う場合もほとんど同様ですが、行頭のメッセージだけは少し異なり、コロン `:` が2つになります。例えば `skk-jisyo` というパッケージ名(変数名ではなくパッケージ名です)のパッケージを変更した場合、メッセージは `gnu: skk-jisyo: メッセージ...` のようになります。つまり、2つのコロンの間にパッケージ名が入ります。これも(私の調べた限りでは)先ほどと同様の慣習の一つで、特に明文化されていないようです。


### パッケージを新しく追加する場合 {#パッケージを新しく追加する場合}

新しいパッケージを追加する場合、気を付けないといけないことがけっこう多いです。詳しいことは[公式マニュアル](https://guix.gnu.org/en/manual/devel/en/html_node/Packaging-Guidelines.html)をご覧ください。


## Guixをビルドする {#guixをビルドする}

<https://guix.gnu.org/en/manual/devel/en/guix.html#Building-from-Git>

```shell
./bootstrap
./configure --localstatedir=/var
make
```
