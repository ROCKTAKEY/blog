+++
title = "自分専用のELPA(Emacs Lisp Package Archive)をGitHubでホストしよう"
author = ["ROCKTAKEY"]
lastmod = 2022-12-22T17:56:12+09:00
tags = ["Emacs", "package.el", "GitHub"]
draft = true
+++

{{< figure src="https://img.shields.io/badge/Emacs%20Advent%20Calendar%202022-13%E6%97%A5%E7%9B%AE-d60a34.svg?style=flat-square&logo=qiita" link="https://qiita.com/advent-calendar/2022/emacs" >}}


## TL;DR {#tl-dr}

-   [template-github-elpa](https://github.com/ROCKTAKEY/template-github-elpa)をテンプレートとしてレポジトリ(仮に"github.com/yourname/A"とする)を作り、 `recipes/` 以下にレシピをコミット
-   `https://yourname.github.io/A/` がパッケージアーカイブとして利用できる


## 序文 {#序文}

[前回の記事](https://blog.rocktakey.com/information-science/2022-df7edb45-d0ce-7cd4-5c6b-1a3efa8b4b4c/)では、パッケージの作り方を扱いました。
パッケージを作ったら、今度は自分のEmacsに導入したいと考えるでしょう。
これを行う方法もいろいろあります。
Emacsのパッケージマネージャを以下に列挙してみます。
GNU GuixやNix、aptなどの汎用パッケージマネージャは除いています。

-   中央集権型
    -   package.el(標準)
-   分散型
    -   [el-get](https://github.com/dimitri/el-get)(ただしpackage.elを透過的に利用可能らしい)
    -   [Cask](https://github.com/cask/cask)
    -   [elpaca](https://github.com/progfolio/elpaca)
    -   [straight.el](https://github.com/radian-software/straight.el)
    -   [quelpa](https://github.com/quelpa/quelpa)

この分類は、パッケージのビルドがどこで行われるかに着目しています。
適当なレシピ、つまりパッケージ定義が与えられた下で、
中央集権型はサーバーにおいてビルドされたパッケージをダウンロードするタイプ、
分散型はローカルでビルドするタイプのパッケージマネージャです。

この二つのタイプに明確な優劣があるわけではなく、一長一短です。
中央集権型の場合には、ローカルにパッケージをビルドする環境を用意する必要がないメリットがあります。
分散型だと環境によってローカルビルドが失敗したり一部のファイル(ドキュメント)などが欠けたりする可能性があります
(ただし現実的に問題になることはほとんどない)が、
中央集権型では(通常ユーザーではない人の管理する)ビルドサーバーの環境さえ整っていれば、
ユーザー側では一切の準備なく完全なパッケージを利用可能です。

一方分散型の場合には、一度レシピ一覧さえダウンロードしてしまえば、
レシピを配信するサーバーが落ちてもビルド自体はローカルなので問題にならないというメリットがあります。
もちろんソースコードを頒布するサーバーが落ちている場合はビルドできませんが、
それはパッケージ単位の話で、全てのパッケージを少数のサーバーに依存する中央集権型にはないメリットです。
ただし、大半の人が `GitHub` や `GitLab` にホストしているため、
実質的には少数のサーバーに依存してしまっているのが現状です。

中央集権型がpackage.elしかなく、分散型がほとんどを占める理由はおそらく単純で、
中央集権型ではサーバー管理が必要になってくるからだと思います。
新しいパッケージマネージャを作ろうと思ったとき、package.elと異なる配信のしかたをするのであれば、
わざわざパッケージをビルドして配信するサーバーを用意せねばなりません。
サーバーを用意しても利用してもらえなければ意味がないし、利用されすぎても管理費がかかる上、
同じ形式のサーバーが他にも立たないと他のパッケージマネージャに対してあまりメリットがなくなってしまいます。
一方package.elと同様の配信形式をそのまま利用するのであれば、単にpackage.elをバックエンドとすればよいでしょう。
すると必然的にpackage.elのラッパとなります。

中央集権型のpackage.elにはもう一つデメリットがあります。
それは、気軽にパッケージを追加できないことです。
分散型の場合、ローカルにビルド環境が必要ですが、それさえ用意してしまえば、
レシピを経由して自作パッケージと他の人のパッケージを統一的に扱うことができます。
しかし中央集権型の場合、ビルド及び配信を行うサーバーを別途用意する必要があります。
package.elはローカルのディレクトリをビルドサーバーに見立てて利用することが可能ではありますが、
その場合、結局ローカルのビルド環境を用意しなければならなくなり、あまり中央集権型の恩恵は受けられません。
さらに、ローカルでのビルドを前提としている分散型とは違い、ビルド環境を用意するのはかなり面倒になります。

そこで、なんらかのホスティングサービスを利用してパッケージをインターネット上に公開することを考えます。
パッケージの配布自体は静的サイトでよく、ビルドを定期的に走らせることで最新のパッケージに更新すればよいです。

ここでは、GitHub ActionsとGitHub Pagesを用いてパッケージをビルドし、パッケージを配布するところまでを行います。
実際にはこのサービスを絶対に利用しなければならないわけではないです。
簡単にGitLabなどの他のサービスへと移植できるよう、なにを行っているかを順に説明するつもりです。
ただし、各パッケージのビルドの具体的なプロセスについては[package-build](https://github.com/melpa/package-build)によって隠蔽されており、
利用にあたって深く知る必要はないため、あまり詳細に解説はしません。


## テンプレートの利用 {#テンプレートの利用}

今回は、[template-github-elpa](https://github.com/ROCKTAKEY/template-github-elpa/)を利用して解説していきます。
このテンプレートは[github-elpa](https://github.com/10sr/github-elpa)を直接の依存としており、これを利用するための諸々の準備を整えるためのテンプレートです。
github-elpaはCLIから直接呼びだせるようになっており、READMEでは[Cask](https://github.com/cask/cask)を利用するように書いています。
しかし、そこに書かれている `cask exec` コマンドは既にCaskから削除されており、そのままでは利用できません。
そこで、このテンプレートでは `keg` を用いた実行に書きなおしています。
ここで `keg` を選んでいる理由は特になく、単に私が慣れているからです。

詳しくは後述しますが、このテンプレートを利用する場合、
`recipes/` 以下にレシピを書いて `keg run build` すれば、 `docs/elpa/` 以下にパッケージアーカイブが作成されます。


## パッケージアーカイブの仕組み {#パッケージアーカイブの仕組み}

パッケージアーカイブの構造は2種類で構成されています。

-   archive
